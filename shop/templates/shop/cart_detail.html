{% extends "base.html" %}
{% load static %}

{% block extra_title %} | Cart{% endblock %}

{% block content %}
<div class="container my-5">
  <h1 class="mb-4"><i class="fas fa-shopping-cart me-2"></i>Your Cart</h1>

  <div id="cart-container">
    {% if cart_items %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Price</th>
              <th style="width: 130px;">Quantity</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cart-items-body">
            {% include 'shop/includes/cart_table.html' %}
          </tbody>
        </table>
      </div>

      <div id="cart-total">
        <div class="text-end mt-4">
          <h4>Total: <span style="color: #00f5d4;">&euro;{{ total }}</span></h4>
          <a href="{% url 'gallery' %}" class="btn btn-outline-primary me-2">
            <i class="fas fa-arrow-left me-1"></i>Continue Shopping
          </a>
          <button id="checkout-button" class="btn btn-primary btn-lg">
            <i class="fas fa-lock me-2"></i>Proceed to Checkout
          </button>
        </div>
      </div>

      <div id="loading-spinner" class="htmx-indicator text-center mt-3">
        <div class="spinner-border text-info" role="status">
          <span class="visually-hidden">Updating...</span>
        </div>
      </div>

    {% else %}
      <div class="text-center py-5">
        <i class="fas fa-shopping-cart fa-4x mb-4" style="color: #c71585; opacity: 0.5;"></i>
        <p class="lead">Your cart is empty.</p>
        <a href="{% url 'gallery' %}" class="btn btn-primary btn-lg">
          <i class="fas fa-images me-2"></i>Browse Prints
        </a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block postloadjs %}
{% if cart_items %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('{{ stripe_public_key }}');
  const checkoutButton = document.getElementById('checkout-button');

  if (checkoutButton) {
    checkoutButton.addEventListener('click', async () => {
      checkoutButton.disabled = true;
      checkoutButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

      try {
        const response = await fetch("{% url 'create_checkout_session' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
          },
        });
        const data = await response.json();

        if (data.error) {
          alert('Error: ' + data.error);
          checkoutButton.disabled = false;
          checkoutButton.innerHTML = '<i class="fas fa-lock me-2"></i>Proceed to Checkout';
        } else {
          const result = await stripe.redirectToCheckout({ sessionId: data.id });
          if (result.error) {
            alert(result.error.message);
          }
        }
      } catch (err) {
        alert('Something went wrong. Please try again.');
        checkoutButton.disabled = false;
        checkoutButton.innerHTML = '<i class="fas fa-lock me-2"></i>Proceed to Checkout';
      }
    });
  }
</script>
{% endif %}
{% endblock %}
